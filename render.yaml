services:
  # Backend API FastAPI
  - type: web
    name: commercia-api
    runtime: python
    plan: starter  # Changez selon vos besoins (starter, standard, pro)

    # Build configuration
    buildCommand: pip install -r requirements.txt
    # 1 worker + timeout 120s pour éviter OOM sur plan starter (512MB RAM)
    startCommand: gunicorn app.main:app -w 1 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120

    # Source
    repo: https://github.com/Mohamedlo10/commercia_back.git  # À remplacer
    branch: main

    # Health check
    healthCheckPath: /health

    # Environment variables
    envVars:
      - key: ENVIRONMENT
        value: production

      - key: DEBUG
        value: false

      - key: SECRET_KEY
        generateValue: true

      - key: DATABASE_URL
        fromDatabase:
          name: commercia-db
          property: connectionString

      - key: BACKEND_CORS_ORIGINS
        value: '*'  # Accept all origins; in production prefer explicit list

      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: 10080  # 7 jours

      - key: ALGORITHM
        value: HS256

    # Autoscaling (optionnel)
    autoDeploy: true

    # Région
    region: frankfurt  # ou oregon, singapore selon votre localisation

# Base de données PostgreSQL (si vous n'utilisez pas Supabase)
# Si vous utilisez Supabase, commentez cette section et utilisez directement
# l'URL de connexion Supabase dans DATABASE_URL

# databases:
#   - name: commercia-db
#     plan: starter  # starter, standard, pro
#     databaseName: commercia
#     user: commercia_user
#     region: frankfurt
#     ipAllowList: []  # Laissez vide pour permettre tous les IPs (ou spécifiez les IPs autorisées)
